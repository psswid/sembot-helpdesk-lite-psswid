<section class="detail" [attr.aria-busy]="loading()">
  <header class="header">
    <a routerLink="/tickets" class="back">← Back to tickets</a>
  </header>

  @if (error(); as err) {
    <p class="error" role="alert" aria-live="polite">{{ err }}
      <button type="button" [disabled]="loading()" (click)="retry()">Retry</button>
    </p>
  }

  @if (loading()) {
    <p class="loading" aria-live="polite">Loading…</p>
  }

  @if (ticket(); as t) {
    <app-ticket-card
      [title]="t.title"
      [description]="t.description"
      [status]="t.status"
      [priority]="t.priority"
      [tags]="t.tags"
      [loading]="loading()"
      [location]="t.location"
      [createdAt]="t.created_at"
    ></app-ticket-card>

    @if (canEdit()) {
      <button class="edit" type="button" [routerLink]="['/tickets', t.id, 'edit']">Edit</button>
    }


    @if (canEdit()) {
      <app-triage-suggestion-panel mode="form" [ticketId]="ticketId()" [canAct]="canEdit()"></app-triage-suggestion-panel>
    }

    @if (t.external?.weather; as weather) {
      <section class="external">
        <h2>Weather</h2>
        <details>
          <summary>Show raw weather data</summary>
          <pre>{{ weather | json }}</pre>
        </details>
      </section>
    }

    <section class="history">
      <h2>Status History</h2>
      @if (history().length === 0) {
        <p>No status changes yet.</p>
      } @else {
        <ol class="timeline">
          @for (h of history(); track h.id) {
            <li>
              <div class="dot" aria-hidden="true"></div>
              <div class="content">
                <div class="row">
                  <strong>{{ h.old_status || '—' }}</strong>
                  <span>→</span>
                  <strong>{{ h.new_status }}</strong>
                </div>
                <div class="row small">
                  <span>{{ h.changed_at }}</span>
                  <span>by {{ (h.changed_by && h.changed_by.name) ? h.changed_by.name : (h.changed_by && h.changed_by.id) ? ('#' + h.changed_by.id) : '—' }}</span>
                </div>
              </div>
            </li>
          }
        </ol>
      }
    </section>
  }
</section>
