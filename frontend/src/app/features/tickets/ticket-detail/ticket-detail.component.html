<section class="detail" [attr.aria-busy]="loading()">
  <header class="header">
    <a routerLink="/tickets" class="back">← Back to tickets</a>
    @if (ticket(); as t) {
      <h1 class="title">{{ t.title }}</h1>
      @if (canEdit()) {
        <a class="edit" [routerLink]="['/tickets', t.id, 'edit']">Edit</a>
      }
    }
  </header>

  @if (error(); as err) {
    <p class="error" role="alert" aria-live="polite">{{ err }}</p>
  }

  @if (loading()) {
    <p class="loading" aria-live="polite">Loading…</p>
  }

  @if (ticket(); as t) {
    <div class="meta">
      <div><strong>Status:</strong> {{ t.status }}</div>
      <div><strong>Priority:</strong> <span [class.low]="t.priority==='low'" [class.medium]="t.priority==='medium'" [class.high]="t.priority==='high'">{{ t.priority }}</span></div>
      <div><strong>Assignee:</strong> {{ t.assignee?.name || '—' }}</div>
      <div><strong>Reporter:</strong> {{ t.reporter?.name || ('#' + t.reporter_id) }}</div>
      <div><strong>Tags:</strong> {{ t.tags.length ? t.tags.join(', ') : '—' }}</div>
      <div><strong>Location:</strong> {{ t.location || '—' }}</div>
      <div><strong>Created:</strong> {{ t.created_at }}</div>
      <div><strong>Updated:</strong> {{ t.updated_at }}</div>
    </div>

    <section class="description">
      <h2>Description</h2>
      <p>{{ t.description }}</p>
    </section>

    @if (canEdit()) {
      <section class="triage">
        <h2>Triage</h2>
        @if (triageError(); as terr) {
          <p class="error" role="alert" aria-live="polite">{{ terr }}</p>
        }
        <div class="triage-actions">
          <button type="button" aria-label="Suggest triage" [disabled]="triageLoading()" (click)="suggest()">Suggest Triage</button>
        </div>

        @if (triageSuggestion(); as s) {
          <div class="suggestion">
            <p><strong>Driver:</strong> {{ s.driver }} @if (s.confidence != null) { ({{ s.confidence | number:'1.0-2' }}) }</p>
            @if (s.reasoning) {
              <details>
                <summary>Reasoning</summary>
                <p>{{ s.reasoning }}</p>
              </details>
            }
            <form class="accept" novalidate [formGroup]="acceptForm" (ngSubmit)="accept()">
              <label>
                <span>Priority</span>
                <select formControlName="priority" required>
                  <option value="low">low</option>
                  <option value="medium">medium</option>
                  <option value="high">high</option>
                </select>
              </label>
              <label class="wide">
                <span>Tags</span>
                <input formControlName="tags" type="text" placeholder="comma separated" />
              </label>
              <label>
                <span>Assignee ID</span>
                <input formControlName="assignee_id" type="number" inputmode="numeric" min="1" placeholder="e.g. 3" />
              </label>
              <label>
                <span>Status</span>
                <select formControlName="status">
                  <option value="">(no change)</option>
                  <option value="open">open</option>
                  <option value="in_progress">in_progress</option>
                  <option value="resolved">resolved</option>
                  <option value="closed">closed</option>
                </select>
              </label>
              <div class="actions">
                <button type="submit" aria-label="Accept triage" [disabled]="triageLoading()">Accept</button>
                <button type="button" aria-label="Reject triage" [disabled]="triageLoading()" (click)="reject()">Reject</button>
              </div>
            </form>
          </div>
        }
      </section>
    }

    @if (t.external?.weather; as weather) {
      <section class="external">
        <h2>Weather</h2>
        <details>
          <summary>Show raw weather data</summary>
          <pre>{{ weather | json }}</pre>
        </details>
      </section>
    }

    <section class="history">
      <h2>Status History</h2>
      @if (history().length === 0) {
        <p>No status changes yet.</p>
      } @else {
        <ol class="timeline">
          @for (h of history(); track h.id) {
            <li>
              <div class="dot" aria-hidden="true"></div>
              <div class="content">
                <div class="row">
                  <strong>{{ h.old_status || '—' }}</strong>
                  <span>→</span>
                  <strong>{{ h.new_status }}</strong>
                </div>
                <div class="row small">
                  <span>{{ h.changed_at }}</span>
                  <span>by {{ h.changed_by?.name || ('#' + h.changed_by_user_id) }}</span>
                </div>
              </div>
            </li>
          }
        </ol>
      }
    </section>
  }
</section>
