<section class="triage" [attr.aria-busy]="loading()">
  <h2>Triage</h2>
  @if (error(); as terr) {
    <p class="error" role="alert" aria-live="polite">{{ terr }}</p>
  }

  <div class="triage-actions">
    <button type="button" aria-label="Suggest triage" [disabled]="loading() || !canAct()" (click)="suggest()">Suggest Triage</button>
    @if (mode() === 'inline' && suggestion()) {
      <button type="button" aria-label="Accept triage" [disabled]="loading() || !canAct()" (click)="accept()">Accept Suggestion</button>
      <button type="button" aria-label="Reject triage" [disabled]="loading() || !canAct()" (click)="reject()">Reject</button>
    }
  </div>

  @if (suggestion(); as s) {
    @if (mode() === 'inline') {
      <p class="hint">
        Suggested priority: <strong>{{ s.priority }}</strong>
        @if (s.tags.length > 0) { â€¢ Tags: {{ s.tags.join(', ') }} }
      </p>
      @if (s.reasoning) { <details><summary>Reasoning</summary><p>{{ s.reasoning }}</p></details> }
      @if (s.confidence != null) { <p class="confidence">Confidence: {{ s.confidence | number:'1.0-2' }}</p> }
    } @else {
      <div class="suggestion">
        <p><strong>Driver:</strong> {{ s.driver }} @if (s.confidence != null) { ({{ s.confidence | number:'1.0-2' }}) }</p>
        @if (s.reasoning) {
          <details>
            <summary>Reasoning</summary>
            <p>{{ s.reasoning }}</p>
          </details>
        }
        <form class="accept" novalidate [formGroup]="acceptForm" (ngSubmit)="accept()">
          <label>
            <span>Priority</span>
            <select formControlName="priority" required>
              <option value="low">low</option>
              <option value="medium">medium</option>
              <option value="high">high</option>
            </select>
          </label>
          <label class="wide">
            <span>Tags</span>
            <input formControlName="tags" type="text" placeholder="comma separated" />
          </label>
          <label>
            <span>Assignee ID</span>
            <input formControlName="assignee_id" type="number" inputmode="numeric" min="1" placeholder="e.g. 3" />
          </label>
          <label>
            <span>Status</span>
            <select formControlName="status">
              <option value="">(no change)</option>
              <option value="open">open</option>
              <option value="in_progress">in_progress</option>
              <option value="resolved">resolved</option>
              <option value="closed">closed</option>
            </select>
          </label>
          <div class="actions">
            <button type="submit" aria-label="Accept triage" [disabled]="loading() || !canAct()">Accept</button>
            <button type="button" aria-label="Reject triage" [disabled]="loading() || !canAct()" (click)="reject()">Reject</button>
          </div>
        </form>
      </div>
    }
  }
</section>
